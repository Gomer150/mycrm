{% extends "deals/base.html" %}
{% block content %}
<h1>Сделки</h1>
<table class="table table-striped">
  <thead><tr><th>Название</th><th>Этап</th><th>Владелец</th><th>Обновлено</th></tr></thead>
  <tbody>
    {% for deal in deals %}
    <tr>
      <td><a href="{% url 'deal_edit' deal.pk %}">{{ deal.title }}</a></td>
      <td>{{ deal.stage }}</td>
      <td>{{ deal.owner.username }}</td>
      <td>{{ deal.updated_at }}</td>
    </tr>
    {% empty %}
    <tr><td colspan="4">Сделок нет</td></tr>
    {% endfor %}
  </tbody>
</table>

<button id="add-deal-btn" class="btn btn-primary mt-3">Добавить сделку</button>

<script>
document.getElementById("add-deal-btn").addEventListener("click", function() {
  fetch("/deals/create/", {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}",
    }
  })
  .then(response => response.json())
  .then(data => {
    // добавляем новую строку в таблицу
    let tbody = document.querySelector("table tbody");
    let tr = document.createElement("tr");
    tr.innerHTML = `
      <td><a href="/deals/${data.id}/edit/">${data.name}</a></td>
      <td>${data.stage}</td>
      <td>{{ request.user.username }}</td>
      <td>${data.created_at}</td>
    `;
    tbody.appendChild(tr);
  });
});
</script>

{% endblock %}

